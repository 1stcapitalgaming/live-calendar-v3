<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Event Calendar</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: transparent; margin: 0; padding: 0; overflow: hidden; } /* No scroll on body */
        .modal-body { max-height: 70vh; }
        /* Custom Scrollbar for inner elements only */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        #loading-indicator { display: flex; }
        #loading-indicator.hidden { display: none; }
    </style>
</head>
<body class="text-gray-800 antialiased">

    <div id="app-container" class="max-w-6xl mx-auto p-2">
        
        <!-- Header / Controls -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 bg-white p-4 rounded-lg shadow-sm border border-gray-100">
            <h2 id="calendar-month-title" class="text-2xl font-bold text-gray-900 mb-4 sm:mb-0">Loading...</h2>
            
            <div class="flex flex-wrap gap-3 items-center justify-center">
                <!-- Navigation -->
                <div class="flex items-center space-x-2 bg-gray-100 rounded-lg p-1">
                    <button id="nav-prev" class="p-2 hover:bg-white rounded-md transition-colors text-indigo-600 disabled:opacity-30 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                    </button>
                    <button id="nav-next" class="p-2 hover:bg-white rounded-md transition-colors text-indigo-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                    </button>
                </div>

                <!-- Filters -->
                <select id="game-filter" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5">
                    <option value="">All Games</option>
                </select>
                
                <!-- Location Filter (Hidden if set via URL) -->
                <select id="location-filter" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5">
                    <option value="">All Locations</option>
                </select>
            </div>
        </div>

        <!-- Calendar Grid -->
        <div id="calendar-grid" class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden min-h-[500px] relative">
            <div id="loading-indicator" class="absolute inset-0 bg-white bg-opacity-90 z-10 justify-center items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
            </div>
            <!-- Grid injected here via JavaScript -->
        </div>

    </div>

    <!-- Details Modal -->
    <div id="details-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg transform transition-all scale-100">
            <div id="details-modal-content" class="p-6 overflow-y-auto modal-body">
                <!-- Content injected here via JavaScript -->
            </div>
            <div class="p-4 bg-gray-50 border-t border-gray-100 flex justify-end rounded-b-xl">
                <button id="details-modal-close" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded shadow-sm transition-all">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://iqalrzfujxultufditwv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlxYWxyemZ1anh1bHR1ZmRpdHd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzQyMzksImV4cCI6MjA4MzU5NDIzOX0.y8CvZxl8iiYQ9LN90g5QQhNfpet7p_D9oBX7psIWmHI';
        
        const LOCATIONS = {
            york: {
                text: "York, PA",
                fullText: "1st Capital Gaming, Eastern Blvd, York, PA",
                url: "https://www.google.com/maps/place/1st+Capital+Gaming/@39.9721164,-76.6784597,17z"
            },
            hagerstown: {
                text: "Hagerstown, MD",
                fullText: "1st Capital Gaming, Premium Outlets Blvd, Hagerstown, MD",
                url: "https://www.google.com/maps/place/1st+Capital+Gaming/@39.6079973,-77.7363654,17z"
            }
        };

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // --- STATE ---
        let allEvents = [];
        let currentMonth = new Date();
        currentMonth.setDate(1); // Always start at 1st of month
        const today = new Date();
        today.setHours(0,0,0,0); // Midnight today

        // --- RESIZE LOGIC (Prevents Scrolling) ---
        function sendHeight() {
            const height = document.body.scrollHeight;
            window.parent.postMessage({ type: 'calendar-resize', height: height }, '*');
        }

        // --- HELPER: TIME FORMATTING (12-Hour) ---
        function formatTime12Hour(time24) {
            if (!time24) return '';
            const [hours, minutes] = time24.split(':');
            let h = parseInt(hours, 10);
            const suffix = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12; // Convert 0 to 12
            return `${h}:${minutes} ${suffix}`;
        }

        // --- INIT ---
        window.addEventListener('load', async () => {
            // Check URL parameters for forced location
            const urlParams = new URLSearchParams(window.location.search);
            const forcedLocation = urlParams.get('location'); 
            
            await fetchEvents();
            
            setupFilters(forcedLocation);
            renderCalendar();
            setupListeners();
            
            // Send initial height and update on resize
            setTimeout(sendHeight, 100); 
            window.addEventListener('resize', sendHeight);
        });

        // --- DATA FETCHING ---
        async function fetchEvents() {
            try {
                const { data, error } = await supabaseClient
                    .from('events')
                    .select('*')
                    .order('start_date', { ascending: true });
                
                if (error) throw error;
                
                allEvents = data.map(e => ({
                    id: e.id,
                    game: e.game,
                    title: e.title,
                    startDate: e.start_date,
                    time: e.time,
                    location: e.location,
                    repeat: e.repeat_pattern,
                    entry: e.entry,
                    format: e.format,
                    description: e.description,
                    prizing: e.prizing,
                    imageUrl: e.image_url,
                    customUrl: e.custom_url,
                    color: e.color,
                    skippedDates: e.skipped_dates || []
                }));

                document.getElementById('loading-indicator').classList.add('hidden');
            } catch (err) {
                console.error("Error fetching events:", err);
                document.getElementById('calendar-grid').innerHTML = '<div class="p-10 text-center text-red-600">Unable to load calendar. Please refresh.</div>';
            }
        }

        // --- RECURRENCE LOGIC ---
        function getEventsForMonth(viewDate) {
            const displayEvents = [];
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0, 23, 59, 59);
            
            const gameFilter = document.getElementById('game-filter').value;
            const locationFilter = document.getElementById('location-filter').value;

            allEvents.forEach(event => {
                if (gameFilter && event.game !== gameFilter) return;
                if (locationFilter && event.location !== locationFilter) return;
                if (!event.startDate || !event.time) return;

                const startDate = new Date(`${event.startDate}T00:00:00`);
                
                if (event.repeat === 'none') {
                    const occurrenceDate = new Date(`${event.startDate}T${event.time}`);
                    // MODIFIED FILTER: Ensure date is >= today AND within current month view
                    if (occurrenceDate >= today && occurrenceDate >= firstDayOfMonth && occurrenceDate <= lastDayOfMonth) {
                        displayEvents.push({ ...event, occurrenceDate });
                    }
                } else {
                    let currentDate = new Date(startDate);
                    let recurrenceLimitDate = new Date(startDate);
                    const farFuture = new Date(); farFuture.setFullYear(farFuture.getFullYear() + 1);

                    if (event.repeat === 'weekly') recurrenceLimitDate = farFuture;
                    else if (event.repeat === 'monthly') recurrenceLimitDate = farFuture;

                    while(currentDate < firstDayOfMonth) {
                        if (event.repeat === 'weekly') currentDate.setDate(currentDate.getDate() + 7);
                        else if (event.repeat === 'monthly') currentDate.setMonth(currentDate.getMonth() + 1);
                    }

                    while(currentDate <= lastDayOfMonth && currentDate <= recurrenceLimitDate) {
                        const dateString = currentDate.toISOString().split('T')[0];
                        if (!event.skippedDates || !event.skippedDates.includes(dateString)) {
                            const occurrenceDate = new Date(`${dateString}T${event.time}`);
                            // MODIFIED FILTER: Ensure date is >= today AND within current month view
                            if (occurrenceDate >= today && occurrenceDate >= firstDayOfMonth && occurrenceDate <= lastDayOfMonth) {
                                displayEvents.push({ ...event, occurrenceDate });
                            }
                        }
                        if (event.repeat === 'weekly') currentDate.setDate(currentDate.getDate() + 7);
                        else if (event.repeat === 'monthly') currentDate.setMonth(currentDate.getMonth() + 1);
                    }
                }
            });

            return displayEvents.sort((a, b) => a.occurrenceDate - b.occurrenceDate);
        }

        // --- RENDERING ---
        function setupFilters(forcedLocation) {
            const gameSelect = document.getElementById('game-filter');
            const locSelect = document.getElementById('location-filter');
            
            const games = [...new Set(allEvents.map(e => e.game).filter(g => g))].sort();
            gameSelect.innerHTML = '<option value="">All Games</option>';
            games.forEach(g => gameSelect.innerHTML += `<option value="${g}">${g}</option>`);

            if (forcedLocation) {
                locSelect.innerHTML = `<option value="${forcedLocation}">${LOCATIONS[forcedLocation]?.text || forcedLocation}</option>`;
                locSelect.value = forcedLocation;
                locSelect.style.display = 'none'; 
            } else {
                locSelect.innerHTML = '<option value="">All Locations</option>';
                Object.keys(LOCATIONS).forEach(key => {
                    locSelect.innerHTML += `<option value="${key}">${LOCATIONS[key].text}</option>`;
                });
            }
        }

        function renderCalendar() {
            const container = document.getElementById('calendar-grid');
            const title = document.getElementById('calendar-month-title');
            
            title.textContent = currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const events = getEventsForMonth(currentMonth);
            
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const firstDayIndex = new Date(year, month, 1).getDay(); 
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            let html = `
                <div class="grid grid-cols-7 border-b border-gray-200 bg-gray-50 text-xs font-semibold text-gray-500 uppercase tracking-wide text-center">
                    ${dayNames.map(d => `<div class="py-3">${d}</div>`).join('')}
                </div>
                <div class="grid grid-cols-7 auto-rows-fr bg-gray-200 gap-px border-b border-gray-200">
            `;

            for(let i=0; i<firstDayIndex; i++) {
                html += `<div class="bg-gray-50 min-h-[100px]">&nbsp;</div>`;
            }

            for(let day=1; day<=daysInMonth; day++) {
                const date = new Date(year, month, day);
                const isToday = (date.setHours(0,0,0,0) === today.getTime());
                const dayEvents = events.filter(e => e.occurrenceDate.getDate() === day);

                html += `
                    <div class="bg-white min-h-[100px] p-1 flex flex-col relative group hover:bg-gray-50 transition-colors">
                        <span class="text-sm font-semibold p-1 ${isToday ? 'bg-indigo-600 text-white rounded-full w-7 h-7 flex items-center justify-center' : 'text-gray-700'}">
                            ${day}
                        </span>
                        <div class="flex-grow space-y-1 mt-1 overflow-y-auto max-h-[150px] custom-scrollbar">
                            ${dayEvents.map(event => `
                                <button onclick="openModal('${event.id}', '${event.occurrenceDate.toISOString()}')" 
                                    class="w-full text-left text-xs p-1.5 rounded border-l-4 shadow-sm hover:shadow-md transition-all truncate block"
                                    style="border-color: ${event.color}; background-color: ${event.color}15;">
                                    <span class="font-bold text-gray-900 block truncate">${formatTime12Hour(event.time)} ${event.title}</span>
                                    ${event.game ? `<span class="text-[10px] text-gray-600 truncate">${event.game}</span>` : ''}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            html += `</div>`; 
            container.innerHTML = html;
            sendHeight(); // RESIZE PARENT AFTER RENDER
        }

        // --- INTERACTION ---
        function setupListeners() {
            document.getElementById('nav-prev').addEventListener('click', () => {
                currentMonth.setMonth(currentMonth.getMonth() - 1);
                renderCalendar();
            });
            document.getElementById('nav-next').addEventListener('click', () => {
                currentMonth.setMonth(currentMonth.getMonth() + 1);
                renderCalendar();
            });
            document.getElementById('game-filter').addEventListener('change', renderCalendar);
            document.getElementById('location-filter').addEventListener('change', renderCalendar);
            
            document.getElementById('details-modal-close').addEventListener('click', () => {
                document.getElementById('details-modal').classList.add('hidden');
            });
            document.getElementById('details-modal').addEventListener('click', (e) => {
                if(e.target.id === 'details-modal') document.getElementById('details-modal').classList.add('hidden');
            });
        }

        window.openModal = (eventId, dateStr) => {
            const event = allEvents.find(e => e.id == eventId);
            if (!event) return;
            const date = new Date(dateStr);
            const content = document.getElementById('details-modal-content');
            const locData = LOCATIONS[event.location];

            content.innerHTML = `
                <div class="relative">
                    ${event.imageUrl ? `<img src="${event.imageUrl}" class="w-full h-48 object-cover rounded-xl mb-4 shadow-sm" onerror="this.style.display='none'">` : ''}
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            ${event.game ? `<span class="bg-indigo-100 text-indigo-800 text-xs font-semibold px-2.5 py-0.5 rounded">${event.game}</span>` : ''}
                            <h2 class="text-2xl font-bold text-gray-900 mt-1">${event.title}</h2>
                        </div>
                    </div>
                    <div class="flex flex-col space-y-2 mb-6 text-sm text-gray-600">
                        <div class="flex items-center"><span class="font-medium text-gray-900">${date.toLocaleDateString('en-US', {weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'})}</span></div>
                        <div class="flex items-center"><span class="font-medium text-gray-900">${formatTime12Hour(event.time)}</span></div>
                        ${locData ? `<div class="flex items-center"><a href="${locData.url}" target="_blank" class="text-indigo-600 hover:underline">${locData.fullText}</a></div>` : ''}
                    </div>
                    ${event.entry ? `<div class="mb-3"><span class="font-semibold text-gray-900">Entry:</span> ${event.entry}</div>` : ''}
                    ${event.format ? `<div class="mb-3"><span class="font-semibold text-gray-900">Format:</span> ${event.format}</div>` : ''}
                    ${event.description ? `<div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-100"><h4 class="font-semibold text-gray-900 mb-1">Description</h4><p class="whitespace-pre-wrap text-gray-700 leading-relaxed">${event.description}</p></div>` : ''}
                    ${event.prizing ? `<div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-100"><h4 class="font-semibold text-gray-900 mb-1">Prizing</h4><p class="whitespace-pre-wrap text-gray-700 leading-relaxed">${event.prizing}</p></div>` : ''}
                    ${event.customUrl ? `<div class="mt-6"><a href="${event.customUrl}" target="_blank" class="block w-full text-center bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow transition-colors">Get Tickets / More Info</a></div>` : ''}
                </div>
            `;
            document.getElementById('details-modal').classList.remove('hidden');
        };
    </script>
</body>
</html>